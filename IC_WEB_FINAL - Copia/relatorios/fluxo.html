<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flowchart with Custom Design</title>

    <!-- Include Bootstrap (optional) -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">

    <!-- Include GSAP from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    
    <style>
        /* Global Styles (from your provided CSS) */
        :root {
          --primary-clr: #7522e6;
          --bg-clr: #f2f4f5;
          --white-bg: #fff;
          --dark-text-clr: #363b46;
          --light-text-clr: #fff;
          --hover-clr: #f1e8fd;
        }

        body {
          font-family: 'Poppins', sans-serif;
          background: var(--bg-clr);
          margin: 0;
          padding: 0;
        }

        .flowchart-container {
          margin: 40px auto;
          max-width: 90%;
          background-color: var(--white-bg);
          padding: 20px;
          border-radius: 10px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .flowchart-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 30px;
        }

        .local-load, .local-unload {
          flex: 1;
          text-align: center;
          font-weight: bold;
          color: var(--primary-clr);
          font-size: 1.1rem;
        }

        .icon-container {
          flex: 2;
          display: flex;
          justify-content: center;
          align-items: center;
          background-color: var(--bg-clr);
          padding: 10px;
          border-radius: 10px;
        }

        .equipment-wrapper {
          display: flex;
          flex-direction: column;
          align-items: center;
          margin-right: 15px;
        }

        /* Equipment icon style: square with padding */
        .equipment-item img {
          width: 60px;
          height: 60px;
          object-fit: contain;
          margin-bottom: 5px;
          border-radius: 4px; /* Square icons */
          background-color: var(--white-bg);
          padding: 5px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* Label for each equipment */
        .equipment-label {
          font-size: 0.85rem;
          color: var(--dark-text-clr);
        }

        /* Animation styling */
        .icon-moving {
          position: relative;
        }

    </style>
</head>

<body>
    <h1 class="text-center">Equipment Flowchart</h1>
    <div class="flowchart-container" id="flowchart-container"></div>

    <script>
        // Utility function to convert hexadecimal string to base64
        function hexToBase64(hexString) {
            const hex = hexString.match(/\w{2}/g).map((byte) => String.fromCharCode(parseInt(byte, 16))).join('');
            return btoa(hex);
        }

        // Function to fetch data from the API
        async function fetchData() {
            try {
                const response = await fetch('https://localhost:7086/api/MinaApi/RecentEquipmentAllocations');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }

        // Function to group equipment by 'local_LOAD' and 'local_UNLOAD'
        function groupByLoadAndUnload(data) {
            return data.reduce((result, item) => {
                const key = `${item.locaL_LOAD}-${item.locaL_UNLOAD}`;
                (result[key] = result[key] || []).push(item);
                return result;
            }, {});
        }

        // Function to create a group container for rows with the same local_LOAD and local_UNLOAD
        function createGroupContainer(localLoad, localUnload) {
            const container = document.getElementById('flowchart-container');
            
            const groupDiv = document.createElement('div');
            groupDiv.classList.add('flowchart-group');

            const groupTitle = document.createElement('h2');
            groupTitle.textContent = `Flow: ${localLoad} â†’ ${localUnload}`;
            groupTitle.classList.add('text-center', 'mb-4', 'text-primary');
            groupDiv.appendChild(groupTitle);

            container.appendChild(groupDiv);
            return groupDiv;
        }

        // Function to create a single row for the grouped equipment
        function createFlowchartRow(equipments, groupDiv) {
            // Create a row for the group of equipment
            const row = document.createElement('div');
            row.classList.add('flowchart-row');

            // Create div for local_load (left)
            const localLoad = document.createElement('div');
            localLoad.classList.add('local-load');
            localLoad.textContent = equipments[0].locaL_LOAD;

            // Create div for equipment icons and names (center)
            const iconContainer = document.createElement('div');
            iconContainer.classList.add('icon-container');

            // Store all the icons so we can apply animation later
            const icons = [];

            // Loop through the equipment in this flow and create icons and labels
            equipments.forEach((equipment, index) => {
                // Create a container for each icon and its label
                const equipmentWrapper = document.createElement('div');
                equipmentWrapper.classList.add('equipment-wrapper');

                // Create label (name of the equipment) below the icon
                const label = document.createElement('div');
                label.classList.add('equipment-label');
                label.textContent = equipment.modelo;

                // Convert the hexadecimal image data to base64
                const base64Image = hexToBase64(equipment.bL_IMAGE_EQT);

                // Add equipment icon as a base64 image
                const icon = document.createElement('img');
                icon.src = `data:image/png;base64,${base64Image}`;  // Assuming it's a PNG image
                icon.alt = equipment.modelo;
                icon.classList.add('equipment-item', 'icon-moving');
                icon.style.zIndex = index;  // To ensure each icon is above the previous one

                // Append label and icon to the wrapper
                equipmentWrapper.appendChild(icon);
                equipmentWrapper.appendChild(label);

                // Add the wrapper to the container
                iconContainer.appendChild(equipmentWrapper);

                // Store the icon element for animation
                icons.push(icon);
            });

            // Create div for local_unload (right)
            const localUnload = document.createElement('div');
            localUnload.classList.add('local-unload');
            localUnload.textContent = equipments[0].locaL_UNLOAD;

            // Append elements to the row
            row.appendChild(localLoad);
            row.appendChild(iconContainer);
            row.appendChild(localUnload);

            // Add the row to the group container
            groupDiv.appendChild(row);

            // Fix the movement boundaries based on the icon container width and icon size
            const maxMovement = iconContainer.clientWidth - 60;  // Account for icon size (60px)

            // Create a timeline for uniform animation
            const timeline = gsap.timeline({ repeat: -1, yoyo: true });

            icons.forEach((icon, index) => {
                // Add each icon to the timeline with staggered delay for sequential movement
                timeline.to(icon, {
                    x: maxMovement,  // Move to the right, stop before the boundary
                    duration: 2,  // Animation duration for each icon
                    ease: "power2.inOut",
                }, index * 2);  // Start the next icon after the previous one completes
            });
        }

        // Initialize the flowchart and group equipment by 'local_LOAD' and 'local_UNLOAD'
        async function initFlowchart() {
            const equipmentData = await fetchData();
            
            // Group the data by 'local_LOAD' and 'local_UNLOAD'
            const groupedData = groupByLoadAndUnload(equipmentData);

            // Iterate over each group
            Object.keys(groupedData).forEach(groupKey => {
                const [localLoad, localUnload] = groupKey.split('-');
                
                // Create a container for each group
                const groupDiv = createGroupContainer(localLoad, localUnload);

                // Add flowchart row for the group
                createFlowchartRow(groupedData[groupKey], groupDiv);
            });
        }

        // Call the init function to start everything
        initFlowchart();
    </script>

    <!-- Bootstrap JS (Optional, for better responsiveness) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
